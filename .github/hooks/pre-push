#!/bin/bash
#
# Pre-push hook that runs the same checks as CI
#

set -e  # Exit immediately if a command exits with a non-zero status

echo "=========================================="
echo "Running pre-push CI checks..."
echo "=========================================="

# Check if required tools are available
command -v forge >/dev/null 2>&1 || { echo "Error: Foundry (forge) is not installed. Please install it from https://getfoundry.sh/"; exit 1; }
command -v npm >/dev/null 2>&1 || { echo "Error: npm is not installed."; exit 1; }

# Set environment variable for Foundry
export FOUNDRY_PROFILE=ci

# ==========================================
# Contracts (Foundry)
# ==========================================
echo ""
echo "=========================================="
echo "Contracts: Running Foundry checks..."
echo "=========================================="

cd contracts

echo ""
echo "[1/3] Running forge fmt --check..."
forge fmt --check

echo ""
echo "[2/3] Running forge build --sizes..."
forge build --sizes

echo ""
echo "[3/3] Running forge test -vv..."
forge test -vv

cd ..

# ==========================================
# Mobile (React Native)
# ==========================================
echo ""
echo "=========================================="
echo "Mobile: Running React Native checks..."
echo "=========================================="

cd mobile

echo ""
echo "[1/3] Installing dependencies..."
npm install

echo ""
echo "[2/3] Running linter..."
npm run lint

echo ""
echo "[3/3] Running tests..."
npm test -- --passWithNoTests

cd ..

# ==========================================
# Web (Vite + React)
# ==========================================
echo ""
echo "=========================================="
echo "Web: Running Vite + React checks..."
echo "=========================================="

cd web

echo ""
echo "[1/4] Installing dependencies..."
npm install

echo ""
echo "[2/4] Running linter..."
npm run lint

echo ""
echo "[3/4] Running build..."
npm run build

echo ""
echo "[4/4] Running tests..."
npm test -- --run

cd ..

# ==========================================
# All checks passed
# ==========================================
echo ""
echo "=========================================="
echo "âœ… All CI checks passed!"
echo "=========================================="
echo ""
echo "Proceeding with push..."
echo ""

exit 0
